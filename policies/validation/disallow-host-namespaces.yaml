# Disallow Host Namespaces Policy
# Prevents pods from sharing host namespaces
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-host-namespaces
  annotations:
    policies.kyverno.io/title: Disallow Host Namespaces
    policies.kyverno.io/category: Pod Security Standards (Baseline)
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/minversion: 1.6.0
    policies.kyverno.io/description: >-
      Host namespaces (Process ID namespace, IPC namespace, and network namespace)
      allow access to shared information and can be used to elevate privileges.
      Pods should not be allowed access to host namespaces.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: host-namespaces
      match:
        any:
          - resources:
              kinds:
                - Pod
      validate:
        message: >-
          Sharing the host namespaces is disallowed. The fields spec.hostNetwork,
          spec.hostIPC, and spec.hostPID must be unset or set to false.
        pattern:
          spec:
            =(hostPID): "false"
            =(hostIPC): "false"
            =(hostNetwork): "false"

---
# Disallow host path volumes
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-host-path
  annotations:
    policies.kyverno.io/title: Disallow hostPath
    policies.kyverno.io/category: Pod Security Standards (Baseline)
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Pod, Volume
    policies.kyverno.io/minversion: 1.6.0
    policies.kyverno.io/description: >-
      HostPath volumes let Pods use host directories and volumes in containers.
      Using host resources can be used to access shared data or escalate privileges.
      This policy ensures no hostPath volumes are in use.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: host-path
      match:
        any:
          - resources:
              kinds:
                - Pod
      validate:
        message: >-
          HostPath volumes are forbidden. The field spec.volumes[*].hostPath must
          be unset.
        pattern:
          spec:
            =(volumes):
              - X(hostPath): "null"

---
# Disallow host ports
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-host-ports
  annotations:
    policies.kyverno.io/title: Disallow Host Ports
    policies.kyverno.io/category: Pod Security Standards (Baseline)
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/minversion: 1.6.0
    policies.kyverno.io/description: >-
      Host ports allow access to applications on the host network and can be
      used to bypass network policies. This policy ensures no host ports are
      in use.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: host-ports-none
      match:
        any:
          - resources:
              kinds:
                - Pod
      validate:
        message: >-
          Use of host ports is disallowed. The field
          spec.containers[*].ports[*].hostPort and
          spec.initContainers[*].ports[*].hostPort must be unset or set to 0.
        pattern:
          spec:
            =(ephemeralContainers):
              - =(ports):
                  - =(hostPort): 0
            =(initContainers):
              - =(ports):
                  - =(hostPort): 0
            containers:
              - =(ports):
                  - =(hostPort): 0

---
# Allow host ports only in specific range (if needed)
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: restrict-host-ports-range
  annotations:
    policies.kyverno.io/title: Restrict Host Ports Range
    policies.kyverno.io/category: Pod Security Standards
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      If host ports must be used, this policy restricts them to a specific range.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: host-ports-range
      match:
        any:
          - resources:
              kinds:
                - Pod
      validate:
        message: "Host ports must be in the range 30000-32767."
        pattern:
          spec:
            containers:
              - =(ports):
                  - =(hostPort): "30000-32767"
